<!DOCTYPE html>
<html>
<head>
<title>FinMate Settings</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="style.css">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

<script src="firebaseConfig.js"></script>
</head>

<body>

<nav class="navbar p-3 shadow-sm" style="background:#ffffff; border-bottom:1px solid #eee;">
  <div class="container d-flex justify-content-between align-items-center">

    <h3 class="m-0 fw-bold" style="color:#222;">⚙️ Settings</h3>

    <button class="btn btn-outline-secondary" onclick="window.location='index.html'">
      ← Back to Dashboard
    </button>

  </div>
</nav>

<div class="container mt-4">

  <div class="card p-4">

    <h4 class="fw-bold mb-1">Monthly Budget Settings</h4>
    <p class="text-secondary">
      Set your monthly allowance and savings goal. You can update it anytime within the same month.
    </p>

    <div id="settingsView">
      <!-- Filled dynamically -->
    </div>

  </div>

</div>

<script>

const app = firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

auth.onAuthStateChanged(async user => {
  if(!user){
    alert("Please Login First");
    window.location = "index.html";
    return;
  }

  loadSettings(user.uid);
});

const monthKey = new Date().getFullYear() + "-" + (new Date().getMonth()+1);

async function loadSettings(uid){

  const doc = await db.collection("users")
    .doc(uid)
    .collection("settings")
    .doc(monthKey)
    .get();

  const box = document.getElementById("settingsView");

  // If NOT set yet
  if(!doc.exists){

    box.innerHTML = `
      <label class="mt-2 text-secondary fw-semibold">Monthly Pocket Money</label>
      <input id="budgetInput" type="number" class="form-control form-control-lg">

      <label class="mt-2 text-secondary fw-semibold">Target Savings</label>
      <input id="savingInput" type="number" class="form-control form-control-lg">

      <button class="btn btn-success rounded-pill px-4 mt-3" onclick="saveSettings()">
        Save Settings
      </button>
    `;
  }

  // Already set → show values & allow edit
  else{
    const data = doc.data();

    box.innerHTML = `
      <h5>Current Month Settings</h5>

      <p><b>Monthly Budget:</b> ₹${data.budget}</p>
      <p><b>Target Savings:</b> ₹${data.saving}</p>

      <button class="btn btn-outline-primary rounded-pill px-4" onclick="editSettings()">
        Edit Settings
      </button>
    `;
  }
}

async function saveSettings(){

  const user = auth.currentUser;

  await db.collection("users")
    .doc(user.uid)
    .collection("settings")
    .doc(monthKey)
    .set({
      budget: Number(budgetInput.value),
      saving: Number(savingInput.value)
    });

  alert("Settings Saved for this Month");
  loadSettings(user.uid);
}

async function editSettings(){
  const user = auth.currentUser;

  const doc = await db.collection("users")
      .doc(user.uid)
      .collection("settings")
      .doc(monthKey)
      .get();

  const data = doc.data();

  document.getElementById("settingsView").innerHTML = `
      <label class="mt-2 text-secondary fw-semibold">Monthly Pocket Money</label>
      <input id="budgetInput" type="number" value="${data.budget}" class="form-control form-control-lg">

      <label class="mt-2 text-secondary fw-semibold">Target Savings</label>
      <input id="savingInput" type="number" value="${data.saving}" class="form-control form-control-lg">

      <button class="btn btn-success rounded-pill px-4 mt-3" onclick="saveSettings()">
        Update Settings
      </button>
  `;
}

</script>

</body>
</html>