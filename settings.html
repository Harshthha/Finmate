<!DOCTYPE html>
<html>
<head>
<title>FinMate Settings</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="style.css">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

<script src="firebaseConfig.js"></script>
</head>

<body>

<nav class="navbar navbar-dark bg-dark p-3 d-flex justify-content-between">
  <h3 class="text-white m-0">⚙️ Settings</h3>

  <button class="btn btn-light" onclick="window.location='index.html'">
    ← Back
  </button>
</nav>

<div class="container mt-4">

  <div class="card p-4">

    <h4>Monthly Budget Settings</h4>
    <p class="text-light">
      Set your monthly allowance & saving goals. You can edit anytime within the same month.
    </p>

    <div id="settingsView">
      <!-- Filled dynamically -->
    </div>

  </div>

</div>

<script>

const app = firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

auth.onAuthStateChanged(async user => {
  if(!user){
    alert("Please Login First");
    window.location = "index.html";
    return;
  }

  loadSettings(user.uid);
});

const monthKey = new Date().getFullYear() + "-" + (new Date().getMonth()+1);

async function loadSettings(uid){

  const doc = await db.collection("users")
    .doc(uid)
    .collection("settings")
    .doc(monthKey)
    .get();

  const box = document.getElementById("settingsView");

  // If NOT set yet
  if(!doc.exists){

    box.innerHTML = `
      <label class="mt-2">Monthly Pocket Money</label>
      <input id="budgetInput" type="number" class="form-control">

      <label class="mt-2">Target Savings</label>
      <input id="savingInput" type="number" class="form-control">

      <button class="btn btn-success mt-3" onclick="saveSettings()">
        Save Settings
      </button>
    `;
  }

  // Already set → show values & allow edit
  else{
    const data = doc.data();

    box.innerHTML = `
      <h5>Current Month Settings</h5>

      <p><b>Monthly Budget:</b> ₹${data.budget}</p>
      <p><b>Target Savings:</b> ₹${data.saving}</p>

      <button class="btn btn-primary" onclick="editSettings()">
        Edit
      </button>
    `;
  }
}

async function saveSettings(){

  const user = auth.currentUser;

  await db.collection("users")
    .doc(user.uid)
    .collection("settings")
    .doc(monthKey)
    .set({
      budget: Number(budgetInput.value),
      saving: Number(savingInput.value)
    });

  alert("Settings Saved for this Month");
  loadSettings(user.uid);
}

async function editSettings(){
  const user = auth.currentUser;

  const doc = await db.collection("users")
      .doc(user.uid)
      .collection("settings")
      .doc(monthKey)
      .get();

  const data = doc.data();

  document.getElementById("settingsView").innerHTML = `
      <label class="mt-2">Monthly Pocket Money</label>
      <input id="budgetInput" type="number" value="${data.budget}" class="form-control">

      <label class="mt-2">Target Savings</label>
      <input id="savingInput" type="number" value="${data.saving}" class="form-control">

      <button class="btn btn-success mt-3" onclick="saveSettings()">
        Update
      </button>
  `;
}

</script>

</body>
</html>